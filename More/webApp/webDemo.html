<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="webDemoCSS.css">
<script src="HEGwebAPI.js"></script>
</head>
<body>
  <title>HEG Interface</title>
  <div class="header">
      <h1>HEG ALPHA Ver 0.0.7</h1>
  </div>
  
  <div id="main_body"></div>

<script> //Custom Scripts and UI setup, feedback modules must be manually linked to session event data (you can mix and match or write your own easily)
  
//Advanced Client scripts using external packages
//Detect that we are not using the default local hosting on the ESP32 so we can grab scripts
if((window.location.hostname != "192.168.4.1") && (window.location.hostname != "esp32.local")) {
  var useAdvanced = true; //Create a global flag to indicate we're capable of using advanced scripts.
}

//------------------------------------------------------------------------
//------------------------------------------------------------------------
//------------------------------------------------------------------------

// Modal Code
var switchHTML = '<label class="switch"><input type="checkbox" id="togBtn"><div class="startslider round"></div></label>';

var tabHTML = '<div id="tabContainer"> \
  <button class="tablink" id="modal_opener">Data</button> \
  <button class="tablink" id="modal_opener2">Graph</button> \
  <button class="tablink" id="modal_opener3">Feedback</button> \
  </div> \
  <div id="modal" class="modal" style="display: none"> \
  <div id="overlay" class="overlay"></div> \
    <div class="modal_content databoxmodal"> \
      <h2>Data Options</h2> \
      <div id="dataBox"></div> \
      <button title="Close" id="close_modal" class="close_modal"> \
          <i class="fas fa-times"></i> \
      </button> \
    </div> \
  </div> \
  <div id="modal2" class="modal" style="display: none"> \
  <div id="overlay2" class="overlay"></div> \
    <div id="graphBox" class="modal_content graphboxmodal"> \
      <h2>Graph Options</h2> \
      <button title="Close" id="close_modal2" class="close_modal"> \
          <i class="fas fa-times"></i> \
      </button> \
    </div> \
  </div> \
  <div id="modal3" class="modal" style="display: none"> \
  <div id="overlay3" class="overlay"></div> \
    <div id = "visualBox" class="modal_content feedbackboxmodal"> \
      <h2>Feedback Options</h2> \
      <button title="Close" id="close_modal3" class="close_modal"> \
          <i class="fas fa-times"></i> \
      </button> \
    </div> \
  </div>';

HEGwebAPI.appendFragment(switchHTML, "main_body");
HEGwebAPI.appendFragment(tabHTML, "main_body");

function attachModalListeners(modalElm, closemodal, overlay) {
  document.getElementById(closemodal).onclick = function() {toggleModal(modalElm, closemodal, overlay)};
  document.getElementById(overlay).onclick = function() {toggleModal(modalElm, closemodal, overlay)};
}

function detachModalListeners(modalElm, closemodal, overlay) {
  document.getElementById(closemodal).onclick = function() {toggleModal(modalElm, closemodal, overlay)};
  document.getElementById(overlay).onclick = function() {toggleModal(modalelm, closemodal, overlay)};
}

function toggleModal(modalElm, closemodal, overlay) {
  var currentState = modalElm.style.display;
  // If modal is visible, hide it. Else, display it.
  if (currentState === 'none') {
    modalElm.style.display = 'block';
    attachModalListeners(modalElm, closemodal, overlay);
  } else {
    modalElm.style.display = 'none';  
    detachModalListeners(modalElm, closemodal, overlay);
  }
}

var modal = document.getElementById('modal');
var modal2 = document.getElementById('modal2');
var modal3 = document.getElementById('modal3');

document.getElementById('modal_opener').onclick = function() {toggleModal(modal,'close_modal','overlay')};
document.getElementById('modal_opener2').onclick = function() {toggleModal(modal2,'close_modal2','overlay2')};
document.getElementById('modal_opener3').onclick = function() {toggleModal(modal3,'close_modal3','overlay3')};

function toggleHEG(switchElement) {
  if (switchElement.checked) {
    document.getElementById('startbutton').click();
  } else {
    document.getElementById('stopbutton').click();
  }
}
document.getElementById("togBtn").onchange = function(){toggleHEG(document.getElementById("togBtn"))};

//------------------------------------------------------------------------
//------------------------------------------------------------------------
//------------------------------------------------------------------------

//Initialize Session
var s = new HEGwebAPI('',false); 

//Initialize Graph
var g = new graphJS(1155,[255,100,80,1],1,[1400,600], "main_body", "g", false); //This could be swapped for a superior graphing package

s.createUI("dataBox");
g.createUI("graphBox")

//Feedback
var c = new circleJS(); //Default animation initialize
var v = null;
var a = null;
var h = null;
var txt = null;


var modeHTML = '<div class="menudiv" id="menudiv"> \
  Modes:<br> \
  <button class="button" id="canvasmode">Circle</button> \
  <button class="button" id="videomode">Video</button> \
  <button class="button" id="audiomode">Audio</button><br> \
  <button class="button" id="hillmode">Hill Climb</button> \
  <button class="button" id="txtmode">Text Reader</button> \
  </div>';

HEGwebAPI.appendFragment(modeHTML,"visualBox");

document.getElementById("canvasmode").onclick = function() {
  if(c == null){
    deInitMode();
    c = new circleJS();
  }
}

document.getElementById("videomode").onclick = function() {
  if(v == null){
    deInitMode();
    v = new videoJS();
  }
}

document.getElementById("audiomode").onclick = function() {
  if(a == null){
    deInitMode();
    a = new audioJS();
  }
}

document.getElementById("hillmode").onclick = function() {
  if(h == null){
    deInitMode();
    h = new hillJS();
  }
}

document.getElementById("txtmode").onclick = function() {
  if(txt == null){
    deInitMode();
    txt = new textReaderJS();
  }
}

//------------------------------------------------------------------------
//------------------------------------------------------------------------

if(useAdvanced) { //Setup advanced scripts now that the default app is ready.
  var link2 = document.createElement("script");
  link2.src = "threeApp.js"; // Can set this to be a nonlocal link like from cloudflare or a special script with a custom app
  document.head.appendChild(link2); //Append script

  var threeApp = null;

  var threeModeHTML = '<button class="button" id="threemode">ThreeJS</button>';
  HEGwebAPI.appendFragment(threeModeHTML,"menudiv");

  document.getElementById("threemode").onclick = function() {
    if(threeApp == null) {
        deInitMode();
        threeApp = new ThreeGlobe();
    }
  }

  //var link3 = document.createElement("script");
  //link3.src = "https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js"; // PDF Viewer JS (text scrolling experiment)
  //document.head.appendChild(link3);
} 

//------------------------------------------------------------------------
//------------------------------------------------------------------------

//Customize session functions
s.handleScore = function() {
  g.us = this.us[this.us.length - 1] - this.startTime;
  if(this.ratio.length > 40){
    if(g.sampleRate == null) {
      g.sampleRate = (this.us[this.us.length - 1] - this.us[0]) * 0.000001 / this.us.length // Seconds / Sample
    }
    this.smaScore(this.ratio);
    var score = this.smaSlope*this.sensitivity.value*0.01;
    if(c != null){
      c.onData(score);
    }
    if (v != null) {
      v.onData(score);
    }
    if(a != null) {
      a.onData(score);
    }
    if(h != null) {
      h.onData(score);
    }
    if(txt != null) {
      txt.onData(score);
    }
    if(useAdvanced) { //Score handling for advanced scripts
      if(threeApp != null) {
        threeApp.onData(score);
      }
    }
    this.scoreArr.push(this.scoreArr[this.scoreArr.length - 1] + score);
    g.ratio = this.slowSMA;
    g.score = this.scoreArr[this.scoreArr.length - 1];
    g.graphY1.shift();
    g.graphY1.push(this.scoreArr[this.scoreArr.length - 1 - g.xoffset]);
    g.graphY2.shift();
    g.graphY2.push(this.slowSMAarr[this.slowSMAarr.length - 1 - g.xoffset]);
  }
  else {
    //this.smaSlope = this.scoreArr[this.scoreArr.length - 1];
    //g.graphY1.shift();
    //g.graphY1.push(this.smaSlope);
    //this.scoreArr.push(this.smaSlope);
  }
  this.updateTable();
}

s.endOfEvent = function() {
  if(g.xoffsetSlider.max < this.scoreArr.length){
    if(this.scoreArr.length % 20 == 0) { 
      g.xoffsetSlider.max = this.scoreArr.length - 3; //Need 2 vertices minimum
    }
  }
}

function deInitMode(){
  if(v != null){
    var thisNode = document.getElementById(v.vidapiId);
    thisNode.parentNode.parentNode.removeChild(thisNode.parentNode);
    thisNode = document.getElementById(v.vidContainerId);    
    thisNode.parentNode.parentNode.removeChild(thisNode.parentNode);
    v.deInit();
    v = null;
  }
  if(a != null){
    a.stopAudio();
    a.endAudio(a);
    var thisNode = document.getElementById(a.audioId);
    thisNode.parentNode.parentNode.removeChild(thisNode.parentNode);
    thisNode = document.getElementById(a.audmenuId);
    thisNode.parentNode.parentNode.removeChild(thisNode.parentNode);
    a = null;
  }
  if(c != null){
    c.deInit();
    c.c.parentNode.parentNode.parentNode.removeChild(c.c.parentNode.parentNode);
    c = null;
  }
  if(h != null){
    h.deInit();
    h.c.parentNode.parentNode.parentNode.removeChild(h.c.parentNode.parentNode);
    h.menu.parentNode.removeChild(h.menu);
    h = null;
  }
  if(txt != null){
    txt.deInit();
    txt.c.parentNode.parentNode.parentNode.removeChild(txt.c.parentNode.parentNode);
    var thisNode = document.getElementById(txt.textId+"menu");
    thisNode.parentNode.parentNode.removeChild(thisNode.parentNode);
    txt = null;
  }
  if(useAdvanced) { //Score handling for advanced scripts
    if(threeApp != null) {
      threeApp.destroyThreeApp();
      threeApp = null;
    }
  }
}


document.getElementById("resetSession").onclick = () => { // Override default function
  s.resetVars();
  g.resetVars();

  if(c != null) {
    deInitMode();
    c = new circleJS();
  }
  if(v != null) {
    deInitMode();
    v = new videoJS();
  }
  if(a != null) {
    deInitMode();
    a = new audioJS();
  }
  if(h != null) {
    deInitMode();
    h = new hillJS();
  }
  if(text != null) {
    deInitMode();
    txt = new textReaderJS();
  }
  if(useAdvanced){
    if(threeApp != null) {
      deInitMode();
      threeApp = new ThreeGlobe();
    }
  }
}


g.xoffsetSlider.onchange = () => {
   if(g.xoffsetSlider.value > s.scoreArr.length) {
     g.xoffsetSlider.value = s.scoreArr.length - 1;
   }
   g.xoffset = g.xoffsetSlider.value;
   
   if(s.scoreArr.length > g.graphY1.length){ //more data than graph size, so just grab a slice of the graph
    var endIndex = s.scoreArr.length - g.xoffset - 1;
    g.graphY1 = s.scoreArr.slice(endIndex - g.graphY1.length, endIndex); // FIX 
    g.graphY2 = s.ratio.slice(endIndex -g.graphY2.length, endIndex);
   }
   else if (s.scoreArr.length < g.graphY1.length) { //less data than graph size, generate zeroes with data from 0 to offset
    var scoreslice = s.scoreArr.slice(0,s.scoreArr.length - 1 - g.xoffset);
    var ratioslice = s.ratio.slice(0,s.ratio.length - 1 - g.xoffset);
    if(g.graphY1.length == scoreslice){
      g.graphY1 = scoreslice;
      g.graphY2 = ratioslice;
    }
    else{
      g.graphY1 = [...Array(g.VERTEX_LENGTH - scoreslice.length).fill(0), ...scoreslice];
      g.graphY2 = [...Array(g.VERTEX_LENGTH - ratioslice.length).fill(0), ...ratioslice];
    }
   }
}

g.xscaleSlider.onchange = () => {
  len = g.graphY1.length;
  if(g.xscaleSlider.value < len) { // Remove from front.
    for(var i = 0; i < len - g.xscaleSlider.value; i++){
      g.graphY1.shift();
      g.graphY2.shift();
    }
  }
  if(g.xscaleSlider.value > len) { // Add to front
    for(var i = 0; i < g.xscaleSlider.value - len; i++){
      if(i+len+g.xoffset <= s.scoreArr.length){
        g.graphY1.unshift(s.scoreArr[s.scoreArr.length - ((len+i) + g.xoffset)]);
        g.graphY2.unshift(s.ratio[s.ratio.length - ((len+i) + g.xoffset)]);
      } 
      else{
        g.graphY1.unshift(0);
        g.graphY2.unshift(0);
      }
    }
  }
  g.VERTEX_LENGTH = g.graphY1.length;
}

document.getElementById("xscalebutton").onclick = () => {
  var len = g.graphY1.length;
  g.xscaleSlider.value = g.nPoints;
  if(g.xscaleSlider.value < len) { // Remove from front.
    for(var i = 0; i < len - g.xscaleSlider.value; i++){
      g.graphY1.shift();
      g.graphY2.shift();
    }
  }
  if(g.xscaleSlider.value > len) { // Add to front
    for(var i = 0; i < g.xscaleSlider.value - len; i++){
      if(g.xscaleSlider.value < s.scoreArr.length){
        g.graphY1.unshift(s.scoreArr[s.scoreArr.length - 1 - ((g.graphY1.length+i) + g.xoffset)]);
        g.graphY2.unshift(s.ratio[s.ratio.length - 1 - ((g.graphY2.length+i) + g.xoffset)]);
      } 
      else{
        g.graphY1.unshift(0);
        g.graphY2.unshift(0);
      }
    }
  }
  g.VERTEX_LENGTH = g.xscaleSlider.value;
}



</script>
</body>
</html>